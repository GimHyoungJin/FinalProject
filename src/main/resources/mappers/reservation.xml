<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="reservation">

    <!-- 누적 관객 수 조회 -->
    <select id="getTotalAudience" parameterType="string" resultType="int">
        SELECT SUM(r.tot_people)
        FROM reservation r
        JOIN screenmovie sm ON r.screen_movie_id = sm.screen_movie_id
        JOIN movie m ON sm.movie_id = m.movie_id
        WHERE m.movie_id = #{movieId}
    </select>

    <!-- 예매율 조회 -->
    <select id="getMovieGrade" parameterType="string" resultType="double">
        SELECT (SUM(r.tot_people) / (SELECT SUM(tot_people) FROM reservation)) * 100
        FROM reservation r
        JOIN screenmovie sm ON r.screen_movie_id = sm.screen_movie_id
        JOIN movie m ON sm.movie_id = m.movie_id
        WHERE m.movie_id = #{movieId}
    </select>

    <!-- 실관람 평점 조회 -->
    <select id="getRating" parameterType="string" resultType="double">
        SELECT AVG(r.rating)
        FROM review r
        JOIN movie m ON r.movie_id = m.movie_id
        WHERE m.movie_id = #{movieId}
    </select>

    <!-- 예약 ID로 예약 정보를 조회 -->
    <select id="getReservationById" parameterType="string" resultType="kr.co.movio.reservation.TicketReservationDTO">
        SELECT res_id, mem_id, screen_movie_id, res_seat_info, adult, teenager, child, tot_people
        FROM reservation
        WHERE res_id = #{reservationId}
    </select>
    
    <select id="isMovieRegisteredByUser" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM reservation r
	    JOIN screenmovie sm ON r.screen_movie_id = sm.screen_movie_id
	    WHERE sm.movie_id = #{movieId} AND r.mem_id = #{memId}
	</select>
	
	<!-- 본 영화 등록 여부 확인 -->
    <select id="isRegistered" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM reservation r
        JOIN screenmovie sm ON r.screen_movie_id = sm.screen_movie_id
        JOIN movie m ON sm.movie_id = m.movie_id
        WHERE m.movie_id = #{movieId} AND r.mem_id = #{memId}
    </select>
</mapper>
