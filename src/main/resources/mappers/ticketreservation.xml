<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    <mapper namespace="ticketreservation">

    <!-- 예약 정보를 저장하는 SQL문 -->
    <insert id="saveReservation" parameterType="kr.co.movio.reservation.TicketReservationDTO">
        INSERT INTO reservation (res_id, mem_id, screen_movie_id, res_seat_info, adult, teenager, child, tot_people)
        VALUES (#{res_id}, #{mem_id}, #{screen_movie_id}, #{res_seat_info}, #{adult}, #{teenager}, #{child}, #{tot_people})
    </insert>

    <!-- 결제 정보를 저장하는 SQL문 -->
    <insert id="savePayment" parameterType="kr.co.movio.reservation.TicketPaymentDTO">
        INSERT INTO payment (pay_id, res_id, used_coupon_information, imp_uid, mer_uid, pay_method, tot_price, dis_price, final_price, pay_status, pay_time, card_information)
        VALUES (#{pay_id}, #{res_id}, #{used_coupon_information}, #{imp_uid}, #{mer_uid}, #{pay_method}, #{tot_price}, #{dis_price}, #{final_price}, #{pay_status}, #{pay_time}, #{card_information})
    </insert>

    <!-- 예약 정보를 가져오는 SQL문 -->
    <select id="getReservation" parameterType="String" resultType="kr.co.movio.reservation.TicketReservationDTO">
        SELECT * FROM reservation WHERE res_id = #{res_id}
    </select>

    <!-- 결제 정보를 가져오는 SQL문 -->
    <select id="getPayment" parameterType="String" resultType="kr.co.movio.reservation.TicketPaymentDTO">
        SELECT * FROM payment WHERE pay_id = #{pay_id}
    </select>

	<!-- 예매번호를 기반으로 예매한 영화, 좌석, 날짜 및 시간, 총금액을 받아오는 쿼리문 -->
	<select id="getReservationDetails" parameterType="String" resultType="java.util.Map">
	    SELECT 
	        r.res_id AS reservation_id,
	        r.res_seat_info AS seats,
	        sm.scmovie_play AS play_date,
	        sm.scmovie_start AS start_time,
	        sm.scmovie_end AS end_time,
	        s.screen_num,
	        m.movie_title,
	        t.theater_name,
	        p.tot_price AS total_amount
	    FROM 
	        reservation r
	    JOIN 
	        screenmovie sm ON r.screen_movie_id = sm.screen_movie_id
	    JOIN 
	        screen s ON sm.screen_id = s.screen_id
	    JOIN 
	        movie m ON sm.movie_id = m.movie_id
	    JOIN 
	        theater t ON s.theater_id = t.theater_id
	    LEFT JOIN 
	        payment p ON r.res_id = p.res_id
	    WHERE 
	        r.res_id = #{res_id}
	</select>

	
    <!-- 예약된 좌석 정보를 가져오는 쿼리 -->
    <select id="getReservedSeats" parameterType="String" resultType="java.util.Map">
	    SELECT res_seat_info
	    FROM reservation
	    WHERE screen_movie_id = #{screen_movie_id}
    </select>
    
    <!-- 총 좌석 수를 가져오는 쿼리 -->
    <select id="getTotalSeats" parameterType="String" resultType="java.util.Map">
        SELECT screen_all_seat
        FROM screen
        WHERE screen_id = #{screen_id}
    </select>
    
    <!-- screenMovieId로 screen_id를 조회하는 쿼리 -->
	<select id="getScreenIdByScreenMovieId" parameterType="String" resultType="String">
	    SELECT screen_id
	    FROM screenmovie
	    WHERE screen_movie_id = #{screen_movie_id}
	</select>

</mapper>