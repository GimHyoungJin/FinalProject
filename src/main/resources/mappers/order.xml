<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.movio.order.OrderMapper">

    <!-- 총 주문 금액 계산 -->
    <select id="totalamount" parameterType="String" resultType="int">
        SELECT SUM(cart_price * cart_amount) FROM cart WHERE mem_id = #{mem_id}
    </select>
    
    <!-- 주문 삽입 -->
    <insert id="orderInsert" parameterType="kr.co.movio.order.OrderDTO">
        INSERT INTO orders (order_no, mem_id, order_total, order_state, order_date)
        VALUES (#{order_no}, #{mem_id}, #{order_total}, #{order_state}, CURRENT_TIMESTAMP)
    </insert>

    <!-- 장바구니 삭제 -->
    <delete id="cartDelete" parameterType="String">
        DELETE FROM cart WHERE mem_id = #{mem_id}
    </delete>

    <!-- 주문 상세 정보 조회 -->
    <select id="orderDesc" parameterType="String" resultType="java.util.Map">
        SELECT od.pro_detail_code, od.order_detail_amount AS quantity, od.order_detail_price AS price
        FROM orderdetail od 
        JOIN orders o ON od.order_no = o.order_no 
        WHERE o.order_no = #{order_no}
    </select>
    
        <!-- 주문 상세 정보 삽입 -->
    <insert id="orderdetailInsert" parameterType="map">
        INSERT INTO orderdetail (order_no, pro_detail_code, order_detail_amount, order_detail_price)
        VALUES (#{order_no}, #{pro_detail_code}, #{order_detail_amount}, #{order_detail_price})
    </insert>
    
    <resultMap id="CartResultMap" type="kr.co.movio.cart.CartDTO">
        <result property="mem_id" column="mem_id" />
        <result property="cart_no" column="cart_no" />
        <result property="pro_detail_code" column="pro_detail_code" />
        <result property="pro_name" column="pro_name" />
        <result property="cart_price" column="cart_price" />
        <result property="cart_amount" column="cart_amount" />
    </resultMap>
    
    <select id="getCartItems" resultMap="CartResultMap">
        SELECT c.cart_no, c.mem_id, c.pro_detail_code, c.cart_price, c.cart_amount, p.pro_name
        FROM cart c
        JOIN product p ON c.pro_detail_code = p.pro_detail_code
        WHERE c.mem_id = #{mem_id}
    </select>
    
    <!-- 결제 정보 삽입 -->
    <insert id="insertPaymentInfo"  parameterType="java.util.Map">
        INSERT INTO productpayment (gift_id, order_no, imp_uid, mer_uid, paid_amount, pay_method, pay_status, card_information)
        VALUES (#{gift_id}, #{order_no}, #{imp_uid}, #{mer_uid}, #{paid_amount}, #{pay_method}, #{pay_status}, #{card_information})
    </insert>
    
    <update id="updateProductStock" parameterType="map">
	    UPDATE product 
	    SET pro_stock = pro_stock - #{orderDetailAmount}
	    WHERE pro_detail_code = #{proDetailCode}
	</update>
    
    
</mapper>
